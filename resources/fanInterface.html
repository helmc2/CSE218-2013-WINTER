<!DOCTYPE HTML>
<html>
<head>
<script src="http://code.jquery.com/jquery-1.9.0.min.js"></script>
<script src="/epochUtils.js"></script>
<title>Hockey Game Manager</title>
<meta charset="UTF-8" />
<link rel="stylesheet" type="text/css" href="reset.css">
<link rel="stylesheet" type="text/css" href="fan_interface_structure.css">

<script>
var DataToShow = { 
	SHOW_GAME_EVENTS	: 0, 
	SHOW_PLAYER_STATS	: 1, 
	SHOW_TEAMS_STATS		: 2 
	};

var games_ids = {};
var players_ids = {};
var team_names = {};
var currently_showing = DataToShow.SHOW_GAME_EVENTS;

var uuid_to_player = {};

$(document).ready(function() {
  	$("#show-event").click(function() {
		source = document.getElementById('selectGame');
		
		for(var i=(source.options.length-1); i>=0; i--){
			if(source.options[i].selected){		
                                var homeD = $.Deferred(), awayD = $.Deferred();
				$.getJSON("/games/"+games_ids[source.options[i].text], function(data,status) 
				{		
					target = document.getElementById('selectPlayer');
					for(var count = target.options.length - 1; count >= 0; count--)
					{
						target.options[count] = null;
					}

					var away_id = data["awayTeam"]; 
					$.getJSON("/teams/"+away_id+"/get-roster", function(data,status) 
					{							
						target.options[target.options.length]=new Option("=="+team_names[away_id]+"==");
						
						for (var i = 0; i < data["data"].length; i++) { 
							var name = data["data"][i]["name"];
							while (name < 30) name += " ";
							var pos = data["data"][i]["position"];
							var num = data["data"][i]["number"];
							var str = "#"+num + " " + name + "\t\t" + "("+pos+")";
							players_ids[target.options.length] = data["data"][i]["id"];
                                                        uuid_to_player[data.data[i].id] = str;
							target.options[target.options.length]=new Option(str);
						}
						awayD.resolve();										
					});		 						
						
					var home_id = data["homeTeam"]; 
					$.getJSON("/teams/"+home_id+"/get-roster", function(data,status) 
					{							
						target.options[target.options.length]=new Option("=="+team_names[home_id]+"==");
						
						for (var i = 0; i < data["data"].length; i++) { 
							var name = data["data"][i]["name"];
							while (name < 30) name += " ";
							var pos = data["data"][i]["position"];
							var num = data["data"][i]["number"];
							var str = "#"+num + " " + name + "\t\t" + "("+pos+")";
							players_ids[target.options.length] = data["data"][i]["id"];	
                                                        uuid_to_player[data.data[i].id] = str;
							//console.log(players_ids[target.options.length]);
							target.options[target.options.length]=new Option(str);							
						}
                                                homeD.resolve();
					});		 													
				});		  	

				$.getJSON("/games/"+games_ids[source.options[i].text]+"/events", function(data,status) 
				{		
                                    $.when(homeD, awayD).then(function() {
					target = document.getElementById('event-box');
					if (data["events"].length == 0)
						target.value = "NO EVENTS RECORDED";
					else 
					{
						target.value = "";
						for (var i = 0; i < data["events"].length; i++) { 
							if (data["events"][i]["time"] != undefined) {
								var time = MillisecToMinSec(data["events"][i]["time"]);
								var str =  time["mins"] + ":" + time["secs"];
								while(str.length < 7) str+=" ";
								target.value += str + " \t\t\t";
							}
							else
								target.value += "??:??" + "\t\t\t";
							
							var team_str = "";
							if (data["events"][i]["teamId"])
								team_str = "(" + team_names[data["events"][i]["teamId"]] + ")";
							
							while (team_str.length < 30) team_str+=" ";
							target.value += team_str+"\t\t\t";
							
							if ("enter-ice" === data["events"][i]["type"])
								target.value += uuid_to_player[data.events[i].playerId] + " Enters Ice\t";
							else if ("exit-ice" === data["events"][i]["type"])
								target.value += uuid_to_player[data.events[i].playerId] + " Exits Ice\t";	
							//else if ("FACEOFF_WON" === data["events"][i]["type"])
							//	target.value += uuid_to_player[data.events[i].playerId] + " Wins Faceoff\t";	
							//else if ("FACEOFF_LOST" === data["events"][i]["type"])
							//	target.value += uuid_to_player[data.events[i].playerId] + " Loses Faceoff\t";	
							else if ("shot" === data["events"][i]["type"])
								target.value += "Shot by " + uuid_to_player[data["events"][i]["playerId"]] + "\t";	
							else if ("penalty" === data["events"][i]["type"])
								target.value += data["events"][i]["penalty"] + "\t";	
							//else if ("HIT" === data["events"][i]["type"])
							//	target.value += data["events"][i]["info"] + "\t";
							//else if ("ASSIST" === data["events"][i]["type"])
							//	target.value += data["events"][i]["info"] + "\t";
							else if ("goal" === data["events"][i]["type"])
								target.value += "GOAL! - " + uuid_to_player[data["events"][i]["playerId"]] + "\t";
							//else if ("SAVE" === data["events"][i]["type"])
							//	target.value += uuid_to_player[data.events[i].playerId] + " Gets a Save\t";		
							else if ("start" === data["events"][i]["type"])
								target.value += "\tStart of Game\t";	
							else if ("end" === data["events"][i]["type"])
								target.value += "\tEnd of Game\t";	
							//else if ("Period Start" === data["events"][i]["type"])
							//	target.value += "\tStart of Period\t";	
							//else if ("Period End" === data["events"][i]["type"])
							//	target.value += "\tEnd of Period\t";	
							
							target.value += "\n";
						}
					}	
                                    });
				});	
				
			}	
		}
  	});
        
	$("#selectPlayer").on("change", function() { 
		var source = document.getElementById('selectPlayer');
		for(var i=(source.options.length-1); i>=0; i--){
			if(source.options[i].selected && players_ids[i] != null){	
				$.getJSON("/players/"+players_ids[i]+"/stats", function(data,status) 
				{							
					var target = document.getElementById('career-stats');
					target.value = "== CAREER STATS ==\n";
					target.value += "Goals:       \t\t" + data["goals"] + "\n";		
					target.value += "Assists:     \t\t" + data["assists"] + "\n";	
					target.value += "Plus Minus:  \t\t" + data["plus-minus"] + "\n";		
					target.value += "Shots:       \t\t" + data["shots"] + "\n";		
					//target.value += "Hits:          \t\t" + data["hits"] + "\n";																	
				});		 
				
				var select_game = document.getElementById('selectGame');
				
				for(var j=(select_game.options.length-1); j>=0; j--){
					if(select_game.options[j].selected){		
						$.getJSON("/players/"+players_ids[i]+"/stats/for-game/"+games_ids[select_game.options[j].text], function(data,status) 
						{			
							var target = document.getElementById('game-stats');				
                                                        console.log(data);
							target.value = "== GAME STATS ==\n";
							target.value += "Goals:       \t\t" + data["goals"] + "\n";		
							target.value += "Assists:     \t\t" + data["assists"] + "\n";	
							target.value += "Plus Minus:  \t\t" + data["plus-minus"] + "\n";		
							target.value += "Shots:       \t\t" + data["shots"] + "\n";		
							//target.value += "Hits:          \t\t" + data["hits"] + "\n";																	
						});		 		
					}
				}
			}
			else
			{
				document.getElementById('career-stats').value = "== CAREER STATS ==";
				document.getElementById('game-stats').value = "== GAME STATS ==";
			}
		}
	});
});	

window.onload=function() {
	// Populate DOMs
	document.getElementById('event-box').value = "";	
	document.getElementById('career-stats').value = "== CAREER STATS ==";
	document.getElementById('game-stats').value = "== GAME STATS ==";
	document.getElementById('home-stats').value = "== HOME STATS ==";
	document.getElementById('away-stats').value = "== AWAY STATS ==";
	
	$.getJSON("/games", function(data,status) 	
	{		
		target = document.getElementById('selectGame');
   				
		for (var i = 0; i < data["data"].length; i++) { 
			var dom_txt = getTeamName(data["data"][i]["awayTeam"]) + " @ " + getTeamName(data["data"][i]["homeTeam"]) + " (" + EpochToDate(data["data"][i]["startTime"]) + ")";
			games_ids[dom_txt] = data["data"][i]["id"];
			target.options[target.options.length]=new Option(dom_txt);
		}      
    });	
	$('.player_events_div').hide();
};

function getTeamName(teamId) {
	var teamName = "undefined";
	$.ajax({
		type: 'GET',
		url: "/teams/"+teamId,
		dataType: 'json',
		success: function(data) {teamName = data["name"];},
		async: false
	});	
	team_names[teamId] = teamName;
	return teamName;
}

function setupPage(dataToShow) {
	if (dataToShow === DataToShow.SHOW_GAME_EVENTS && currently_showing !== DataToShow.SHOW_GAME_EVENTS)
	{
		showing_game_events = true;
		$('.player_events_div').hide();
		$('.teams_stats_div').hide();
		$('.game_stats_div').show();
		currently_showing = DataToShow.SHOW_GAME_EVENTS;
	}
	else if (dataToShow === DataToShow.SHOW_PLAYER_STATS && currently_showing !== DataToShow.SHOW_PLAYER_STATS)
	{
		$('.game_stats_div').hide();
		$('.teams_stats_div').hide();
		$('.player_events_div').show();
		currently_showing = DataToShow.SHOW_PLAYER_STATS;
	}
	else if (dataToShow === DataToShow.SHOW_TEAMS_STATS && currently_showing !== DataToShow.SHOW_TEAMS_STATS)
	{
		$('.game_stats_div').hide();
		$('.teams_stats_div').show();
		$('.player_events_div').hide();		
		currently_showing = DataToShow.SHOW_TEAMS_STATS;
	}
}

</script>

</head>

<body>
<div class="box panel" action="/openid" method="POST">
	<fieldset class="boxBody">
	  <label>Fan Interface</label>	  
	</fieldset>
    
	<content>	  
            <td align="left">Games:</td> </br>
            <td align="left"><select name="selectGame" id="selectGame" style="width: 600px;">
            </select></td>
            <button type="submit" id="show-event" class="btn" style="visibility: visible">Update</button>
        	</br> 
            <a onClick=setupPage(DataToShow.SHOW_GAME_EVENTS)>Game Events</a>  |  <a onClick=setupPage(DataToShow.SHOW_PLAYER_STATS)>Player Stats</a>  |  <a onClick=setupPage(DataToShow.SHOW_TEAMS_STATS)>Teams Stats</a>
            
            <div class="game_stats_div">
                <textarea readonly id="event-box" rows="4" style="width: 940px; height: 440px; margin-top: 10px; resize: none;">
                </textarea>          
            </div>
            
             <div class="player_events_div">
             	</br>
             	<td><select name="selectPlayer" id="selectPlayer" style="width: 450px;">
           		</select></td>
                </br>
                <textarea readonly id="game-stats" rows="4" style="width: 465px; height: 400px; margin-top: 10px; resize: none;">
Game Stats:
                </textarea>   
                <textarea readonly id="career-stats" rows="4" style="width: 465px; height: 400px; margin-top: 10px; resize: none;">
Career Stats:
                </textarea>        
            </div>
            
            <div class="teams_stats_div">             	
                <textarea readonly id="away-stats" rows="4" style="width: 465px; height: 440px; margin-top: 10px; resize: none;">
Away Team Stats:
                </textarea>   
                <textarea readonly id="home-stats" rows="4" style="width: 465px; height: 440px; margin-top: 10px; resize: none;">
Home Team Stats:
                </textarea>        
            </div>
	</content>
    
</div>
<footer id="main">
  Hockey Game Manager | CSE 218
</footer>

    <div id="content"></div>

</body>
</html>
